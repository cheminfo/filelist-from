<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test</title>
    <style>
      .file-container {
        display: flex;
      }
      .file-listing {
        background-color: pink;
      }
      .file-collection {
        background-color: lightgreen;
      }
    </style>
  </head>
  <body>
    <header>
      <p>Filelist v FileCollection Browser Comparison</p>
    </header>
    <section>
      <p>Select files:</p>
      <input type="file" id="filePicker" name="fileCollection" multiple />
    </section>
    <section>
      <p>Or select directories:</p>
      <input
        type="file"
        id="directoryPicker"
        name="fileCollection"
        multiple
        webkitdirectory="true"
      />
    </section>
    <div class="file-container">
      <div class="file-listing" id="listing"></div>
      <div class="file-collection" id="listingCollection"></div>
    </div>
    <script type="module">
      import {
        fileCollectionFromFileList,
        fileCollectionFromWebSource,
      } from './src/index.ts';

      const filePicker = document.getElementById('filePicker');
      const directoryPicker = document.getElementById('directoryPicker');

      filePicker.addEventListener('change', onChange);
      directoryPicker.addEventListener('change', onChange);

      async function onChange(event) {
        const files = event.target.files;
        console.log(files);
        await displayFileList(files);
        const fileCollection = await fileCollectionFromFileList(files);
        console.log(fileCollection);
        await displayFileCollection(fileCollection);
      }

      async function displayFileList(files) {
        const listing = document.getElementById('listing');
        const html = [
          '<table>',
          '<tr><th>webkitRelativePath</th><th>name</th><th>Text size</th><th>ArrayBuffer size</th></tr>',
        ];
        for (const file of files) {
          html.push(
            `<tr><td>${file.webkitRelativePath}</td><td>${file.name}</td><td>${
              (await file.text()).length
            }</td><td>${(await file.arrayBuffer()).byteLength}</td></tr>`,
          );
        }
        html.push('</table>');
        listing.innerHTML = html.join('\n');
      }

      async function displayFileCollection(fileCollection) {
        const listing = document.getElementById('listingCollection');
        const html = [
          '<table>',
          '<tr><th>relativePath</th><th>name</th><th>Text size</th><th>ArrayBuffer size</th></tr>',
        ];
        for (const file of fileCollection) {
          html.push(
            `<tr><td>${file.relativePath}</td><td>${file.name}</td><td>${
              (await file.text()).length
            }</td><td>${(await file.arrayBuffer()).byteLength}</td></tr>`,
          );
        }
        html.push('</table>');
        listing.innerHTML = html.join('\n');
      }

      async function getWebServiceFiles() {
        const webSource = 'https://zakodium-oss.github.io/analysis-dataset/';
        const json = await fetch(`${webSource}gcms.json`).then((res) =>
          res.json(),
        );
        const fileCollection = await fileCollectionFromWebSource({
          entries: json,
          baseURL: webSource,
        });

        for (let i = 0; i < 10; i++) {
          console.log(await fileCollection.files[0].text());
          console.log(await fileCollection.files[0].arrayBuffer());
          await delay(5000);
        }
      }

      function delay(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      getWebServiceFiles();
    </script>
  </body>
</html>
